{"meta":{"version":1,"warehouse":"1.0.3"},"models":{"Asset":[{"_id":"themes/apollo/source/scss/apollo.scss","path":"scss/apollo.scss","modified":0},{"_id":"themes/apollo/source/favicon.png","path":"favicon.png","modified":0},{"_id":"themes/apollo/source/css/apollo.css","path":"css/apollo.css","modified":0}],"Cache":[{"_id":"source/_posts/auto-deploy-hexo-with-github-webhooks.md","shasum":"f1cc4fe869c9ade04fcffa4b302622e8ce5641d4","modified":1450704521000},{"_id":"source/_posts/hello-world.md","shasum":"774b507901d9b17991ace2a70263b6dd6d11999a","modified":1450449077000},{"_id":"source/_posts/config-ssl-in-nginx.md","shasum":"a7c9d9aaf8a9301f9b94a356a0b05cef5f26cba0","modified":1450668758000},{"_id":"source/_posts/install-nodejs-and-hexo-in-aliyun-centos.md","shasum":"d9436df84ee1015c28f65e29076ed7b312fe7a74","modified":1450664867000},{"_id":"themes/apollo/LICENSE","shasum":"6e31ac9076bfc8f09ae47977419eee4edfb63e5b","modified":1450495410000},{"_id":"themes/apollo/README.md","shasum":"fdaa691c63bba80c75b17e9426c06f148dfb9dc4","modified":1450495410000},{"_id":"themes/apollo/_config.yml","shasum":"d740b11c3133ce65f1f7f186422f3a11de63e7c4","modified":1450497974000},{"_id":"themes/apollo/doc/custom-blocks.md","shasum":"78e9400714d0ff7c9b272d3ccc80fb18c3bf208f","modified":1450495410000},{"_id":"themes/apollo/gulpfile.babel.js","shasum":"ae6ba496e2672ed07050295954ca3da8b0ef423c","modified":1450495410000},{"_id":"themes/apollo/layout/index.jade","shasum":"58c451042cad5beeb5a76852bba609c651ff3428","modified":1450495410000},{"_id":"themes/apollo/layout/mixins/paginator.jade","shasum":"510ee0ba37b4522cca6c6204d641809454ba3ac6","modified":1450495410000},{"_id":"themes/apollo/layout/mixins/post.jade","shasum":"37411bb13470bbfdb78b300ad4feffd2a2737086","modified":1450495410000},{"_id":"themes/apollo/layout/partial/comment.jade","shasum":"ff0a2c269c2434da2ac5529872f1d6184a71f96d","modified":1450495410000},{"_id":"themes/apollo/layout/partial/head.jade","shasum":"1dc82f6c2caac5419a1bd793f33b44b3490eddba","modified":1450532627000},{"_id":"themes/apollo/layout/partial/layout.jade","shasum":"d9c4f8933f6740f5159713ec69ab943db5fb7cae","modified":1450495410000},{"_id":"themes/apollo/layout/partial/nav.jade","shasum":"c35d3061da4b053b73150d9741c542d660798270","modified":1450495410000},{"_id":"themes/apollo/layout/partial/scripts.jade","shasum":"ed937de186642bb8d11defc2b1c5cbf3388aa59e","modified":1450497749000},{"_id":"themes/apollo/layout/post.jade","shasum":"7593ff041af04c387c457417237d9ab9e3cb467d","modified":1450495410000},{"_id":"themes/apollo/package.json","shasum":"a872d0158d522612ccc0b300bdf27d0228de8428","modified":1450495410000},{"_id":"themes/apollo/source/css/apollo.css","shasum":"2f4d716a8cbda4c8de6547624696adbc19c01881","modified":1450495410000},{"_id":"themes/apollo/source/favicon.png","shasum":"a9cdcb22d1e74d5480323e19d1983de5a6873b8c","modified":1450495410000},{"_id":"themes/apollo/source/scss/_partial/base.scss","shasum":"88b361e68475caddbab763feed5e1db788ac2cd7","modified":1450495410000},{"_id":"themes/apollo/source/scss/_partial/footer.scss","shasum":"60cf365489c0d93cd7e9f10eedd4aee702e1ef27","modified":1450495410000},{"_id":"themes/apollo/source/scss/_partial/header.scss","shasum":"d24cc6520f3faa7bb80610b858a92639eadcc289","modified":1450495410000},{"_id":"themes/apollo/source/scss/_partial/mq.scss","shasum":"0b9c7097136ac8e4a07d9702fc4dbe0345ac7596","modified":1450495410000},{"_id":"themes/apollo/source/scss/_partial/normalize.scss","shasum":"fd0b27bed6f103ea95b08f698ea663ff576dbcf1","modified":1450495410000},{"_id":"themes/apollo/source/scss/_partial/post.scss","shasum":"8ca0ffea647c28ed0b158635a142e43ae052b2f2","modified":1450495410000},{"_id":"themes/apollo/source/scss/_partial/posts.scss","shasum":"92858015b8f3dcb4eb91b6dc41563b7aaa91b376","modified":1450495410000},{"_id":"themes/apollo/source/scss/apollo.scss","shasum":"f8b40223ea647b7c5627c344ead5c1a493bdd576","modified":1450495410000},{"_id":"public/scss/apollo.scss","modified":1450690225742,"shasum":"f8b40223ea647b7c5627c344ead5c1a493bdd576"},{"_id":"public/favicon.png","modified":1450690225747,"shasum":"a9cdcb22d1e74d5480323e19d1983de5a6873b8c"},{"_id":"public/css/apollo.css","modified":1450690225749,"shasum":"2f4d716a8cbda4c8de6547624696adbc19c01881"},{"_id":"public/2015/12/21/auto-deploy-hexo-with-github-webhooks/index.html","modified":1450704539114,"shasum":"187390e6eaac9ee9cfbfde31ebd825ae2d562f79"},{"_id":"public/2015/12/20/config-ssl-in-nginx/index.html","modified":1450690226007,"shasum":"854bf826bb6f0af805a341ad04283ac4dcdad46e"},{"_id":"public/2015/12/19/install-nodejs-and-hexo-in-aliyun-centos/index.html","modified":1450690226056,"shasum":"352710f91aed6a1d78e42fa69ed14bdab70b8f87"},{"_id":"public/2015/12/18/hello-world/index.html","modified":1450690226099,"shasum":"e72eebc8b9b80ef1d6e3597017a27158406b2931"},{"_id":"public/archives/index.html","modified":1450704539308,"shasum":"38c143171a8d3e4031aeb69e9ed48f94ae57baad"},{"_id":"public/archives/2015/index.html","modified":1450704539347,"shasum":"38c143171a8d3e4031aeb69e9ed48f94ae57baad"},{"_id":"public/archives/2015/12/index.html","modified":1450704539389,"shasum":"38c143171a8d3e4031aeb69e9ed48f94ae57baad"},{"_id":"public/atom.xml","modified":1450704539438,"shasum":"83462deffcf8c9e47f693e0cdc3ef9b59dcbd850"},{"_id":"public/categories/blog/index.html","modified":1450704539431,"shasum":"749f7b3c6598794ccaac29723a8509f6f21528d3"},{"_id":"public/index.html","modified":1450704539492,"shasum":"e36a812fa2dd7b4b961b67287d23b1f7515b919e"},{"_id":"public/sitemap.xml","modified":1450704539495,"shasum":"9b45bb48d188d7384aedf559d6ba5b8697261c1c"},{"_id":"public/tags/aliyun/index.html","modified":1450690226372,"shasum":"40cdfcc996f2a1f57517deef275c0db0a6b2d12a"},{"_id":"public/tags/ecs/index.html","modified":1450690226413,"shasum":"40cdfcc996f2a1f57517deef275c0db0a6b2d12a"},{"_id":"public/tags/centos/index.html","modified":1450690226455,"shasum":"40cdfcc996f2a1f57517deef275c0db0a6b2d12a"},{"_id":"public/tags/nodejs/index.html","modified":1450690226482,"shasum":"a911cdad0a8e36f8ac387338d9892baafff3f530"},{"_id":"public/tags/hexo/index.html","modified":1450704539661,"shasum":"640c5c114acb6573c9f39ee09a69afacd4e2d060"},{"_id":"public/tags/nginx/index.html","modified":1450690226552,"shasum":"8fb466b5f01ccca6b2ca13c3df0436eb43c5a7ca"},{"_id":"public/tags/ssl/index.html","modified":1450690226592,"shasum":"8fb466b5f01ccca6b2ca13c3df0436eb43c5a7ca"},{"_id":"public/tags/https/index.html","modified":1450690226625,"shasum":"8fb466b5f01ccca6b2ca13c3df0436eb43c5a7ca"},{"_id":"public/tags/github/index.html","modified":1450704539794,"shasum":"28000ab82f0431a793ddbcbf798d51887ba7cd67"},{"_id":"public/tags/webhooks/index.html","modified":1450704539819,"shasum":"28000ab82f0431a793ddbcbf798d51887ba7cd67"},{"_id":"public/tags/deploy/index.html","modified":1450704539859,"shasum":"28000ab82f0431a793ddbcbf798d51887ba7cd67"},{"_id":"public/tags/shell/index.html","modified":1450704539889,"shasum":"28000ab82f0431a793ddbcbf798d51887ba7cd67"}],"Category":[{"name":"blog","_id":"ciifri5l90002i2xxhcomgur9"}],"Data":[],"Page":[],"Post":[{"title":"使用Github的Webhooks实现hexo的自动部署","date":"2015-12-21T09:29:24.000Z","_content":"博客之前的更新方式是先在本地写好文章，push到Github，然后ssh连到服务器上，pull下来，每次都要这样操作一遍实在麻烦，今天尝试使用Github的Webhooks功能实现了hexo的自动部署，过程记录如下。\n\n<!--more-->\n\n整个过程有两个环节：\n\n### 本地代码自动部署到Github\n\nhexo本身就有deploy功能，只要在`_config.yml`里面做一下[配置](https://hexo.io/zh-cn/docs/deployment.html)，就可以部署到Github、Heroku等平台上，如果博客是托管在Github Pages上的话使用这种方式可以很方便的实现自动部署，不过通过这种方式发送到Github上的只有`public`目录，我这里希望托管整个应用的代码，就不能使用这种方式了，反正只要可以push就行了，我们搬出shell大法好。\n\n创建文件`deploy.sh`\n\n{% codeblock %}\n#!/bin/bash\n\necho -e \"\\033[32m [AUTO DEPLOY] deploy hexo start \\033[0m\"\necho -e \"\\033[32m [AUTO DEPLOY] hexo generate...  \\033[0m\"\nhexo g\necho -e \"\\033[32m [AUTO DEPLOY] git commit...  \\033[0m\"\nd=`date +%x-%T`\ngit add .\ngit commit -m \"auto deploy at \"${d}\necho -e \"\\033[32m [AUTO DEPLOY] git push...  \\033[0m\"\ngit push origin master\necho -e \"\\033[32m [AUTO DEPLOY] deploy hexo finish \\033[0m\"\n{% endcodeblock %}\n\n然后增加权限\n\n{% codeblock %}\nchmod +x ./deploy.sh\n{% endcodeblock %}\n\n这样完成本地开发后，只要执行命令\n\n{% codeblock %}\n./deploy.sh\n{% endcodeblock %}\n\n就可以让hexo生成静态文件并push到Github上。\n\n### Github自动同步到服务器\n\n为了让服务器可以自动同步Github上面的更新，我们需要用到Github的Webhooks。\n\n首先创建文件`sync.sh`\n\n{% codeblock %}\n#!/bin/bash\n\necho -e \"\\033[32m [AUTO SYNC] sync hexo start \\033[0m\"\ncd /ppxu/blog\necho -e \"\\033[32m [AUTO SYNC] git pull...  \\033[0m\"\ngit pull origin master\necho -e \"\\033[32m [AUTO SYNC] sync hexo finish \\033[0m\"\n{% endcodeblock %}\n\n目标是每当Github有push的时候就自动调用这个脚本。\n\n然后找到Github仓库的Settings页\n\n![http://7xpbfd.com1.z0.glb.clouddn.com/hook.png](http://7xpbfd.com1.z0.glb.clouddn.com/hook.png)\n\n添加一条Webhook，填写请求地址`http://xx.xx.xx.xx:7777/webhook`，这样每当Github收到push或者其他事件时就会自动向这个地址发送一条POST请求。\n\n下面在服务器上补充这个请求地址，我们用node搭一个简单的http服务，这里用到了[github-webhook-handler](https://github.com/rvagg/github-webhook-handler)处理hook消息，创建文件`server.js`\n\n{% codeblock %}\nvar http = require('http')\nvar exec = require('child_process').exec;\nvar createHandler = require('github-webhook-handler')\nvar handler = createHandler({ path: '/webhook', secret: '********' });\n\nhttp.createServer(function (req, res) {\n  handler(req, res, function (err) {\n    res.statusCode = 404;\n    res.end('no such location');\n  });\n}).listen(7777);\n\nhandler.on('error', function (err) {\n  console.error('Error:', err.message);\n});\n\nhandler.on('push', function (event) {\n  console.log('Received a push event for %s to %s',\n    event.payload.repository.name,\n    event.payload.ref);\n  exec('/ppxu/blog/sync.sh', function(err, stdout, stderr){\n    if(err) {\n      console.log('sync server err: ' + stderr);\n    } else {\n      console.log(stdout);\n    }\n  });\n});\n{% endcodeblock %}\n\n这里的`secret`要和在Github上新建hook时设置的一样，请求时校验用的。\n\n然后启动服务\n\n{% codeblock %}\nnode server.js &\n{% endcodeblock %}\n\n这里也可以用forever之类的工具防止进程挂掉。\n\n这样一套自动部署系统就建立好了，在本机和服务器的实际效果如下：\n\n![http://7xpbfd.com1.z0.glb.clouddn.com/deploy.png](http://7xpbfd.com1.z0.glb.clouddn.com/deploy.png)\n\n![http://7xpbfd.com1.z0.glb.clouddn.com/sync.png](http://7xpbfd.com1.z0.glb.clouddn.com/sync.png)\n\n感觉生活一下子美好起来了呢：）\n\n#### 参考资料\n\n* [https://hexo.io/zh-cn/docs/deployment.html](https://hexo.io/zh-cn/docs/deployment.html)\n\n* [https://developer.github.com/webhooks/](https://developer.github.com/webhooks/)\n\n* [http://www.lovelucy.info/auto-deploy-website-by-webhooks-of-github-and-gitlab.html](http://www.lovelucy.info/auto-deploy-website-by-webhooks-of-github-and-gitlab.html)\n","source":"_posts/auto-deploy-hexo-with-github-webhooks.md","raw":"title: 使用Github的Webhooks实现hexo的自动部署\ndate: 2015-12-21 17:29:24\ncategories: blog\ntags: [github, webhooks, hexo, deploy, shell]\n---\n博客之前的更新方式是先在本地写好文章，push到Github，然后ssh连到服务器上，pull下来，每次都要这样操作一遍实在麻烦，今天尝试使用Github的Webhooks功能实现了hexo的自动部署，过程记录如下。\n\n<!--more-->\n\n整个过程有两个环节：\n\n### 本地代码自动部署到Github\n\nhexo本身就有deploy功能，只要在`_config.yml`里面做一下[配置](https://hexo.io/zh-cn/docs/deployment.html)，就可以部署到Github、Heroku等平台上，如果博客是托管在Github Pages上的话使用这种方式可以很方便的实现自动部署，不过通过这种方式发送到Github上的只有`public`目录，我这里希望托管整个应用的代码，就不能使用这种方式了，反正只要可以push就行了，我们搬出shell大法好。\n\n创建文件`deploy.sh`\n\n{% codeblock %}\n#!/bin/bash\n\necho -e \"\\033[32m [AUTO DEPLOY] deploy hexo start \\033[0m\"\necho -e \"\\033[32m [AUTO DEPLOY] hexo generate...  \\033[0m\"\nhexo g\necho -e \"\\033[32m [AUTO DEPLOY] git commit...  \\033[0m\"\nd=`date +%x-%T`\ngit add .\ngit commit -m \"auto deploy at \"${d}\necho -e \"\\033[32m [AUTO DEPLOY] git push...  \\033[0m\"\ngit push origin master\necho -e \"\\033[32m [AUTO DEPLOY] deploy hexo finish \\033[0m\"\n{% endcodeblock %}\n\n然后增加权限\n\n{% codeblock %}\nchmod +x ./deploy.sh\n{% endcodeblock %}\n\n这样完成本地开发后，只要执行命令\n\n{% codeblock %}\n./deploy.sh\n{% endcodeblock %}\n\n就可以让hexo生成静态文件并push到Github上。\n\n### Github自动同步到服务器\n\n为了让服务器可以自动同步Github上面的更新，我们需要用到Github的Webhooks。\n\n首先创建文件`sync.sh`\n\n{% codeblock %}\n#!/bin/bash\n\necho -e \"\\033[32m [AUTO SYNC] sync hexo start \\033[0m\"\ncd /ppxu/blog\necho -e \"\\033[32m [AUTO SYNC] git pull...  \\033[0m\"\ngit pull origin master\necho -e \"\\033[32m [AUTO SYNC] sync hexo finish \\033[0m\"\n{% endcodeblock %}\n\n目标是每当Github有push的时候就自动调用这个脚本。\n\n然后找到Github仓库的Settings页\n\n![http://7xpbfd.com1.z0.glb.clouddn.com/hook.png](http://7xpbfd.com1.z0.glb.clouddn.com/hook.png)\n\n添加一条Webhook，填写请求地址`http://xx.xx.xx.xx:7777/webhook`，这样每当Github收到push或者其他事件时就会自动向这个地址发送一条POST请求。\n\n下面在服务器上补充这个请求地址，我们用node搭一个简单的http服务，这里用到了[github-webhook-handler](https://github.com/rvagg/github-webhook-handler)处理hook消息，创建文件`server.js`\n\n{% codeblock %}\nvar http = require('http')\nvar exec = require('child_process').exec;\nvar createHandler = require('github-webhook-handler')\nvar handler = createHandler({ path: '/webhook', secret: '********' });\n\nhttp.createServer(function (req, res) {\n  handler(req, res, function (err) {\n    res.statusCode = 404;\n    res.end('no such location');\n  });\n}).listen(7777);\n\nhandler.on('error', function (err) {\n  console.error('Error:', err.message);\n});\n\nhandler.on('push', function (event) {\n  console.log('Received a push event for %s to %s',\n    event.payload.repository.name,\n    event.payload.ref);\n  exec('/ppxu/blog/sync.sh', function(err, stdout, stderr){\n    if(err) {\n      console.log('sync server err: ' + stderr);\n    } else {\n      console.log(stdout);\n    }\n  });\n});\n{% endcodeblock %}\n\n这里的`secret`要和在Github上新建hook时设置的一样，请求时校验用的。\n\n然后启动服务\n\n{% codeblock %}\nnode server.js &\n{% endcodeblock %}\n\n这里也可以用forever之类的工具防止进程挂掉。\n\n这样一套自动部署系统就建立好了，在本机和服务器的实际效果如下：\n\n![http://7xpbfd.com1.z0.glb.clouddn.com/deploy.png](http://7xpbfd.com1.z0.glb.clouddn.com/deploy.png)\n\n![http://7xpbfd.com1.z0.glb.clouddn.com/sync.png](http://7xpbfd.com1.z0.glb.clouddn.com/sync.png)\n\n感觉生活一下子美好起来了呢：）\n\n#### 参考资料\n\n* [https://hexo.io/zh-cn/docs/deployment.html](https://hexo.io/zh-cn/docs/deployment.html)\n\n* [https://developer.github.com/webhooks/](https://developer.github.com/webhooks/)\n\n* [http://www.lovelucy.info/auto-deploy-website-by-webhooks-of-github-and-gitlab.html](http://www.lovelucy.info/auto-deploy-website-by-webhooks-of-github-and-gitlab.html)\n","slug":"auto-deploy-hexo-with-github-webhooks","published":1,"updated":"2015-12-21T13:28:41.000Z","_id":"ciifri5kz0000i2xx6lnwhboy","comments":1,"layout":"post","photos":[],"link":""},{"title":"阿里云ECS搭建hexo","date":"2015-12-19T02:31:27.000Z","_content":"最近刚撸了个阿里云ECS服务器来折腾，先搭个hexo博客耍耍，这里记录一下操作步骤。\n\n<!--more-->\n\n撸主选的是最便宜的阿里云ECS，应付日常小撸应该足够了，具体配置如下：\n\n{% codeblock %}\nCPU：1核\n内存：1024MB\n操作系统：CentOS 7.0 64位\n带宽：1Mbps\n{% endcodeblock %}\n\n下面是具体的手法：\n\n* 连接服务器\n\n{% codeblock %}\nssh root@xx.xx.xx.xx\n{% endcodeblock %}\n\n* 安装Nodejs环境\n\n  * 更新软件源\n\n  {% codeblock %}\n  yum -y update\n  {% endcodeblock %}\n\n  * 下载Nodejs\n\n  {% codeblock %}\n  cd /usr/local/src\n  wget http://nodejs.org/dist/node-latest.tar.gz\n  {% endcodeblock %}\n\n  * 解压\n\n  {% codeblock %}\n  tar zxf node-latest.tar.gz\n  cd node-v*.*.*\n  {% endcodeblock %}\n\n  * 编译安装\n\n  {% codeblock %}\n  ./configure\n  make\n  make install\n  {% endcodeblock %}\n\n  * 确认安装成功\n\n  {% codeblock %}\n  node -v\n  npm -v\n  {% endcodeblock %}\n\n* 安装hexo\n\n{% codeblock %}\nnpm install -g hexo-cli\nhexo init blog\ncd blog\nnpm install\n{% endcodeblock %}\n\n* 启动hexo\n\n{% codeblock %}\nhexo server    //普通启动\nhexo server &  //静默启动\n{% endcodeblock %}\n\n启动成功后就可以通过服务器的ip地址`xx.xx.xx.xx:4000`访问到页面了，然后需要把4000转到80上，通常做法是用nginx做反向代理，这里先用iptables防火墙简单做一下转发处理。\n\n* 转到80端口\n\n编辑iptables文件\n\n{% codeblock %}\nvi /etc/sysconfig/iptables\n{% endcodeblock %}\n\n加上下面这段\n\n{% codeblock %}\n-A INPUT -m state --state NEW -m tcp -p tcp --dport 80 -j ACCEPT\n-A INPUT -m state --state NEW -m tcp -p tcp --dport 4000 -j ACCEPT\n\n*nat\n-A PREROUTING -p tcp --dport 80 -j REDIRECT --to-ports 4000\nCOMMIT\n{% endcodeblock %}\n\n重启iptables服务\n\n{% codeblock %}\nservice iptables restart\n{% endcodeblock %}\n\n这时发现报错了\n\n{% codeblock %}\nFailed to restart iptables.service: Unit iptables.service failed to load: No such file or directory.\n{% endcodeblock %}\n\n查了一下原来是CentOS 7中的防火墙改成了firewalld，所以要换回iptables。\n\n{% codeblock %}\nsystemctl stop firewalld\nsystemctl mask firewalld\nyum install iptables-services\nsystemctl enable iptables\nservice iptables start\n{% endcodeblock %}\n\n这样就可以通过ip地址`xx.xx.xx.xx`直接访问网站了。\n\n* 域名解析\n\n再撸个域名`ppxu.me`，把`@`和`www`都解析到服务器ip地址就可以了。\n\n* git管理\n\n再配置一下git环境，以后就可以通过git来管理内容了。\n\n#### 参考资料\n\n* [https://hexo.io/zh-cn/docs/index.html](https://hexo.io/zh-cn/docs/index.html)\n* [http://wsgzao.github.io/post/hexo-guide/](http://wsgzao.github.io/post/hexo-guide/)\n* [http://zipperary.com/categories/hexo/](http://zipperary.com/categories/hexo/)\n* [http://www.jianshu.com/p/73779eacb494](http://www.jianshu.com/p/73779eacb494)\n* [http://www.tuijiankan.com/2015/05/04/阿里云Centos6安装配置Nodejs、Nginx、Hexo操作记录/](http://www.tuijiankan.com/2015/05/04/%E9%98%BF%E9%87%8C%E4%BA%91Centos6%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AENodejs%E3%80%81Nginx%E3%80%81Hexo%E6%93%8D%E4%BD%9C%E8%AE%B0%E5%BD%95/)\n* [http://codybonney.com/installing-node-js-0-10-24-on-centos-6-4/](http://codybonney.com/installing-node-js-0-10-24-on-centos-6-4/)\n* [http://codybonney.com/redirect-port-80-to-another-port-using-iptables-on-centos/](http://codybonney.com/redirect-port-80-to-another-port-using-iptables-on-centos/)\n* [http://www.vkilo.com/rhel-7-iptables-service.html](http://www.vkilo.com/rhel-7-iptables-service.html)\n","source":"_posts/install-nodejs-and-hexo-in-aliyun-centos.md","raw":"title: 阿里云ECS搭建hexo\ndate: 2015-12-19 10:31:27\ncategories: blog\ntags: [aliyun, ecs, centos, nodejs, hexo]\n---\n最近刚撸了个阿里云ECS服务器来折腾，先搭个hexo博客耍耍，这里记录一下操作步骤。\n\n<!--more-->\n\n撸主选的是最便宜的阿里云ECS，应付日常小撸应该足够了，具体配置如下：\n\n{% codeblock %}\nCPU：1核\n内存：1024MB\n操作系统：CentOS 7.0 64位\n带宽：1Mbps\n{% endcodeblock %}\n\n下面是具体的手法：\n\n* 连接服务器\n\n{% codeblock %}\nssh root@xx.xx.xx.xx\n{% endcodeblock %}\n\n* 安装Nodejs环境\n\n  * 更新软件源\n\n  {% codeblock %}\n  yum -y update\n  {% endcodeblock %}\n\n  * 下载Nodejs\n\n  {% codeblock %}\n  cd /usr/local/src\n  wget http://nodejs.org/dist/node-latest.tar.gz\n  {% endcodeblock %}\n\n  * 解压\n\n  {% codeblock %}\n  tar zxf node-latest.tar.gz\n  cd node-v*.*.*\n  {% endcodeblock %}\n\n  * 编译安装\n\n  {% codeblock %}\n  ./configure\n  make\n  make install\n  {% endcodeblock %}\n\n  * 确认安装成功\n\n  {% codeblock %}\n  node -v\n  npm -v\n  {% endcodeblock %}\n\n* 安装hexo\n\n{% codeblock %}\nnpm install -g hexo-cli\nhexo init blog\ncd blog\nnpm install\n{% endcodeblock %}\n\n* 启动hexo\n\n{% codeblock %}\nhexo server    //普通启动\nhexo server &  //静默启动\n{% endcodeblock %}\n\n启动成功后就可以通过服务器的ip地址`xx.xx.xx.xx:4000`访问到页面了，然后需要把4000转到80上，通常做法是用nginx做反向代理，这里先用iptables防火墙简单做一下转发处理。\n\n* 转到80端口\n\n编辑iptables文件\n\n{% codeblock %}\nvi /etc/sysconfig/iptables\n{% endcodeblock %}\n\n加上下面这段\n\n{% codeblock %}\n-A INPUT -m state --state NEW -m tcp -p tcp --dport 80 -j ACCEPT\n-A INPUT -m state --state NEW -m tcp -p tcp --dport 4000 -j ACCEPT\n\n*nat\n-A PREROUTING -p tcp --dport 80 -j REDIRECT --to-ports 4000\nCOMMIT\n{% endcodeblock %}\n\n重启iptables服务\n\n{% codeblock %}\nservice iptables restart\n{% endcodeblock %}\n\n这时发现报错了\n\n{% codeblock %}\nFailed to restart iptables.service: Unit iptables.service failed to load: No such file or directory.\n{% endcodeblock %}\n\n查了一下原来是CentOS 7中的防火墙改成了firewalld，所以要换回iptables。\n\n{% codeblock %}\nsystemctl stop firewalld\nsystemctl mask firewalld\nyum install iptables-services\nsystemctl enable iptables\nservice iptables start\n{% endcodeblock %}\n\n这样就可以通过ip地址`xx.xx.xx.xx`直接访问网站了。\n\n* 域名解析\n\n再撸个域名`ppxu.me`，把`@`和`www`都解析到服务器ip地址就可以了。\n\n* git管理\n\n再配置一下git环境，以后就可以通过git来管理内容了。\n\n#### 参考资料\n\n* [https://hexo.io/zh-cn/docs/index.html](https://hexo.io/zh-cn/docs/index.html)\n* [http://wsgzao.github.io/post/hexo-guide/](http://wsgzao.github.io/post/hexo-guide/)\n* [http://zipperary.com/categories/hexo/](http://zipperary.com/categories/hexo/)\n* [http://www.jianshu.com/p/73779eacb494](http://www.jianshu.com/p/73779eacb494)\n* [http://www.tuijiankan.com/2015/05/04/阿里云Centos6安装配置Nodejs、Nginx、Hexo操作记录/](http://www.tuijiankan.com/2015/05/04/%E9%98%BF%E9%87%8C%E4%BA%91Centos6%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AENodejs%E3%80%81Nginx%E3%80%81Hexo%E6%93%8D%E4%BD%9C%E8%AE%B0%E5%BD%95/)\n* [http://codybonney.com/installing-node-js-0-10-24-on-centos-6-4/](http://codybonney.com/installing-node-js-0-10-24-on-centos-6-4/)\n* [http://codybonney.com/redirect-port-80-to-another-port-using-iptables-on-centos/](http://codybonney.com/redirect-port-80-to-another-port-using-iptables-on-centos/)\n* [http://www.vkilo.com/rhel-7-iptables-service.html](http://www.vkilo.com/rhel-7-iptables-service.html)\n","slug":"install-nodejs-and-hexo-in-aliyun-centos","published":1,"updated":"2015-12-21T02:27:47.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciifri5l80001i2xxnoiodqpj"},{"title":"Hello World","_content":"Welcome to [Hexo](http://hexo.io/)! This is your very first post. Check [documentation](http://hexo.io/docs/) for more info. If you get any problems when using Hexo, you can find the answer in [troubleshooting](http://hexo.io/docs/troubleshooting.html) or you can ask me on [GitHub](https://github.com/hexojs/hexo/issues).\n\n## Quick Start\n\n### Create a new post\n\n``` bash\n$ hexo new \"My New Post\"\n```\n\nMore info: [Writing](http://hexo.io/docs/writing.html)\n\n### Run server\n\n``` bash\n$ hexo server\n```\n\nMore info: [Server](http://hexo.io/docs/server.html)\n\n### Generate static files\n\n``` bash\n$ hexo generate\n```\n\nMore info: [Generating](http://hexo.io/docs/generating.html)\n\n### Deploy to remote sites\n\n``` bash\n$ hexo deploy\n```\n\nMore info: [Deployment](http://hexo.io/docs/deployment.html)\n","source":"_posts/hello-world.md","raw":"title: Hello World\n---\nWelcome to [Hexo](http://hexo.io/)! This is your very first post. Check [documentation](http://hexo.io/docs/) for more info. If you get any problems when using Hexo, you can find the answer in [troubleshooting](http://hexo.io/docs/troubleshooting.html) or you can ask me on [GitHub](https://github.com/hexojs/hexo/issues).\n\n## Quick Start\n\n### Create a new post\n\n``` bash\n$ hexo new \"My New Post\"\n```\n\nMore info: [Writing](http://hexo.io/docs/writing.html)\n\n### Run server\n\n``` bash\n$ hexo server\n```\n\nMore info: [Server](http://hexo.io/docs/server.html)\n\n### Generate static files\n\n``` bash\n$ hexo generate\n```\n\nMore info: [Generating](http://hexo.io/docs/generating.html)\n\n### Deploy to remote sites\n\n``` bash\n$ hexo deploy\n```\n\nMore info: [Deployment](http://hexo.io/docs/deployment.html)\n","slug":"hello-world","published":1,"date":"2015-12-18T14:31:17.000Z","updated":"2015-12-18T14:31:17.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciifri5lg000ei2xx5leasxpq"},{"title":"配置nginx和ssl","date":"2015-12-20T14:01:05.000Z","_content":"今天给服务器安装了nginx，并配置了ssl，网址左边终于有萌萌哒的小绿锁了，这里还是做一下记录。\n\n<!--more-->\n\n先是安装nginx\n\n{% codeblock %}\nwget http://nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm\nrpm -ivh nginx-release-centos-7-0.el7.ngx.noarch.rpm\nyum install nginx\n{% endcodeblock %}\n\n启动nginx\n\n{% codeblock %}\nsystemctl start nginx\n{% endcodeblock %}\n\n这样nginx服务就已经可以访问了，输入服务器ip地址就可以看到nginx主页，然后我们需要把hexo服务的4000端口转发到nginx的80端口，查看nginx配置文件`/etc/nginx/nginx.conf`，看到需要修改`conf.d`目录下的`/etc/nginx/conf.d/default.conf`文件\n\n{% codeblock %}\nserver {\n    listen       80;\n    server_name  ppxu.me *.ppxu.me;\n\n    location / {\n        proxy_pass          http://127.0.0.1:4000/;\n        proxy_redirect      off;\n        proxy_set_header    X-Real-IP       $remote_addr;\n        proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;\n    }\n\n    ...\n{% endcodeblock %}\n\n重启nginx\n\n{% codeblock %}\nsystemctl restart nginx\n{% endcodeblock %}\n\n现在访问网站，在响应头里就可以看到`Server:nginx/1.8.0`，说明nginx环境已经正常了，下面准备搞上HTTPS。\n\n这里就不详述HTTPS的原理了，对我们这个小博客而言，搞个免费的SSL证书就可以了，这里推荐[https://startssl.com/](https://startssl.com/)或者[https://www.wosign.com/](https://www.wosign.com/)，申请成功后把下载下来的对应版本的证书文件上传到服务器上，包含公钥`.crt`和私钥`.key`。\n\n然后编辑`/etc/nginx/conf.d/default.conf`\n\n{% codeblock %}\nserver {\n    listen       80;\n    listen       443 ssl;\n    server_name  ppxu.me *.ppxu.me;\n\n    ssl on;\n    ssl_certificate /etc/nginx/conf.d/ppxu.crt;\n    ssl_certificate_key /etc/nginx/conf.d/ppxu.key;\n    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;\n    ssl_ciphers 'AES128+EECDH:AES128+EDH:!aNULL';\n    ssl_prefer_server_ciphers on;\n    ssl_session_cache shared:SSL:10m;\n    ssl_session_timeout 10m;\n    ssl_stapling on;\n    ssl_stapling_verify on;\n\n    location / {\n        proxy_pass          http://127.0.0.1:4000/;\n        proxy_redirect      off;\n        proxy_set_header    X-Real-IP       $remote_addr;\n        proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;\n    }\n\n    ...\n{% endcodeblock %}\n\n重启nginx，如果一切顺利，现在就可以通过`https://ppxu.me`访问到本网站了，但是直接如果直接输入`ppxu.me`的话会报400错误，显示\n\n{% codeblock %}\nThe plain HTTP request was sent to HTTPS port\n{% endcodeblock %}\n\n所以我们需要将http的请求强制使用https访问，这里有一个方法是使用497错误码做重定向，在`/etc/nginx/conf.d/default.conf`中添加一条错误规则\n\n{% codeblock %}\nerror_page 497  https://$host$uri;\n{% endcodeblock %}\n\n这样我们的网站就已经完全支持了HTTPS访问，可以在这个网站[https://www.ssllabs.com/ssltest/analyze.html](https://www.ssllabs.com/ssltest/analyze.html)对网页进行安全评测，如果评分不够高的话可以再看看如何[加强nginx的SSL安全](http://www.oschina.net/translate/strong_ssl_security_on_nginx)。\n\n![http://7xpbfd.com1.z0.glb.clouddn.com/ssl.png](http://7xpbfd.com1.z0.glb.clouddn.com/ssl.png)\n\n#### 参考资料\n\n* [http://codybonney.com/installing-nginx-on-centos-6-4/](http://codybonney.com/installing-nginx-on-centos-6-4/)\n* [http://www.tuijiankan.com/2015/05/04/阿里云Centos6安装配置Nodejs、Nginx、Hexo操作记录/](http://www.tuijiankan.com/2015/05/04/%E9%98%BF%E9%87%8C%E4%BA%91Centos6%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AENodejs%E3%80%81Nginx%E3%80%81Hexo%E6%93%8D%E4%BD%9C%E8%AE%B0%E5%BD%95/)\n* [http://www.barretlee.com/blog/2015/10/05/how-to-build-a-https-server/](http://www.barretlee.com/blog/2015/10/05/how-to-build-a-https-server/)\n* [http://www.ha97.com/5194.html](http://www.ha97.com/5194.html)\n* [http://www.cnblogs.com/yanghuahui/archive/2012/06/25/2561568.html](http://www.cnblogs.com/yanghuahui/archive/2012/06/25/2561568.html)\n* [http://www.codeceo.com/article/nginx-ssl-nodejs.html](http://www.codeceo.com/article/nginx-ssl-nodejs.html)\n* [http://www.ttlsa.com/nginx/nginx-node-js/](http://www.ttlsa.com/nginx/nginx-node-js/)\n* [http://blog.csdn.net/wzy_1988/article/details/8549290](http://blog.csdn.net/wzy_1988/article/details/8549290)\n* [http://www.tutugreen.com/wordpress/upgrade-ssl/](http://www.tutugreen.com/wordpress/upgrade-ssl/)\n* [http://www.oschina.net/translate/strong_ssl_security_on_nginx](http://www.oschina.net/translate/strong_ssl_security_on_nginx)\n* [http://blog.jobbole.com/44844/](http://blog.jobbole.com/44844/)\n* [http://blog.jobbole.com/80591/](http://blog.jobbole.com/80591/)\n","source":"_posts/config-ssl-in-nginx.md","raw":"title: 配置nginx和ssl\ndate: 2015-12-20 22:01:05\ncategories: blog\ntags: [aliyun, ecs, centos, nginx, ssl, https]\n---\n今天给服务器安装了nginx，并配置了ssl，网址左边终于有萌萌哒的小绿锁了，这里还是做一下记录。\n\n<!--more-->\n\n先是安装nginx\n\n{% codeblock %}\nwget http://nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm\nrpm -ivh nginx-release-centos-7-0.el7.ngx.noarch.rpm\nyum install nginx\n{% endcodeblock %}\n\n启动nginx\n\n{% codeblock %}\nsystemctl start nginx\n{% endcodeblock %}\n\n这样nginx服务就已经可以访问了，输入服务器ip地址就可以看到nginx主页，然后我们需要把hexo服务的4000端口转发到nginx的80端口，查看nginx配置文件`/etc/nginx/nginx.conf`，看到需要修改`conf.d`目录下的`/etc/nginx/conf.d/default.conf`文件\n\n{% codeblock %}\nserver {\n    listen       80;\n    server_name  ppxu.me *.ppxu.me;\n\n    location / {\n        proxy_pass          http://127.0.0.1:4000/;\n        proxy_redirect      off;\n        proxy_set_header    X-Real-IP       $remote_addr;\n        proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;\n    }\n\n    ...\n{% endcodeblock %}\n\n重启nginx\n\n{% codeblock %}\nsystemctl restart nginx\n{% endcodeblock %}\n\n现在访问网站，在响应头里就可以看到`Server:nginx/1.8.0`，说明nginx环境已经正常了，下面准备搞上HTTPS。\n\n这里就不详述HTTPS的原理了，对我们这个小博客而言，搞个免费的SSL证书就可以了，这里推荐[https://startssl.com/](https://startssl.com/)或者[https://www.wosign.com/](https://www.wosign.com/)，申请成功后把下载下来的对应版本的证书文件上传到服务器上，包含公钥`.crt`和私钥`.key`。\n\n然后编辑`/etc/nginx/conf.d/default.conf`\n\n{% codeblock %}\nserver {\n    listen       80;\n    listen       443 ssl;\n    server_name  ppxu.me *.ppxu.me;\n\n    ssl on;\n    ssl_certificate /etc/nginx/conf.d/ppxu.crt;\n    ssl_certificate_key /etc/nginx/conf.d/ppxu.key;\n    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;\n    ssl_ciphers 'AES128+EECDH:AES128+EDH:!aNULL';\n    ssl_prefer_server_ciphers on;\n    ssl_session_cache shared:SSL:10m;\n    ssl_session_timeout 10m;\n    ssl_stapling on;\n    ssl_stapling_verify on;\n\n    location / {\n        proxy_pass          http://127.0.0.1:4000/;\n        proxy_redirect      off;\n        proxy_set_header    X-Real-IP       $remote_addr;\n        proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;\n    }\n\n    ...\n{% endcodeblock %}\n\n重启nginx，如果一切顺利，现在就可以通过`https://ppxu.me`访问到本网站了，但是直接如果直接输入`ppxu.me`的话会报400错误，显示\n\n{% codeblock %}\nThe plain HTTP request was sent to HTTPS port\n{% endcodeblock %}\n\n所以我们需要将http的请求强制使用https访问，这里有一个方法是使用497错误码做重定向，在`/etc/nginx/conf.d/default.conf`中添加一条错误规则\n\n{% codeblock %}\nerror_page 497  https://$host$uri;\n{% endcodeblock %}\n\n这样我们的网站就已经完全支持了HTTPS访问，可以在这个网站[https://www.ssllabs.com/ssltest/analyze.html](https://www.ssllabs.com/ssltest/analyze.html)对网页进行安全评测，如果评分不够高的话可以再看看如何[加强nginx的SSL安全](http://www.oschina.net/translate/strong_ssl_security_on_nginx)。\n\n![http://7xpbfd.com1.z0.glb.clouddn.com/ssl.png](http://7xpbfd.com1.z0.glb.clouddn.com/ssl.png)\n\n#### 参考资料\n\n* [http://codybonney.com/installing-nginx-on-centos-6-4/](http://codybonney.com/installing-nginx-on-centos-6-4/)\n* [http://www.tuijiankan.com/2015/05/04/阿里云Centos6安装配置Nodejs、Nginx、Hexo操作记录/](http://www.tuijiankan.com/2015/05/04/%E9%98%BF%E9%87%8C%E4%BA%91Centos6%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AENodejs%E3%80%81Nginx%E3%80%81Hexo%E6%93%8D%E4%BD%9C%E8%AE%B0%E5%BD%95/)\n* [http://www.barretlee.com/blog/2015/10/05/how-to-build-a-https-server/](http://www.barretlee.com/blog/2015/10/05/how-to-build-a-https-server/)\n* [http://www.ha97.com/5194.html](http://www.ha97.com/5194.html)\n* [http://www.cnblogs.com/yanghuahui/archive/2012/06/25/2561568.html](http://www.cnblogs.com/yanghuahui/archive/2012/06/25/2561568.html)\n* [http://www.codeceo.com/article/nginx-ssl-nodejs.html](http://www.codeceo.com/article/nginx-ssl-nodejs.html)\n* [http://www.ttlsa.com/nginx/nginx-node-js/](http://www.ttlsa.com/nginx/nginx-node-js/)\n* [http://blog.csdn.net/wzy_1988/article/details/8549290](http://blog.csdn.net/wzy_1988/article/details/8549290)\n* [http://www.tutugreen.com/wordpress/upgrade-ssl/](http://www.tutugreen.com/wordpress/upgrade-ssl/)\n* [http://www.oschina.net/translate/strong_ssl_security_on_nginx](http://www.oschina.net/translate/strong_ssl_security_on_nginx)\n* [http://blog.jobbole.com/44844/](http://blog.jobbole.com/44844/)\n* [http://blog.jobbole.com/80591/](http://blog.jobbole.com/80591/)\n","slug":"config-ssl-in-nginx","published":1,"updated":"2015-12-21T03:32:38.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciifri5lk000fi2xxbr6mfeb9"}],"PostAsset":[],"PostCategory":[{"post_id":"ciifri5l80001i2xxnoiodqpj","category_id":"ciifri5l90002i2xxhcomgur9","_id":"ciifri5ld0005i2xxgl3ouoyx"},{"post_id":"ciifri5lk000fi2xxbr6mfeb9","category_id":"ciifri5l90002i2xxhcomgur9","_id":"ciifri5ll000gi2xxl957mnw2"},{"post_id":"ciifri5kz0000i2xx6lnwhboy","category_id":"ciifri5l90002i2xxhcomgur9","_id":"ciig00ko10001z2xxcemxo1in"}],"PostTag":[{"post_id":"ciifri5l80001i2xxnoiodqpj","tag_id":"ciifri5la0003i2xx8ny3t399","_id":"ciifri5le0009i2xxxd6ju71c"},{"post_id":"ciifri5l80001i2xxnoiodqpj","tag_id":"ciifri5lc0004i2xxdrom057p","_id":"ciifri5lf000ai2xx3rinbpon"},{"post_id":"ciifri5l80001i2xxnoiodqpj","tag_id":"ciifri5ld0006i2xxi8fifmfh","_id":"ciifri5lf000bi2xxbr6sanqj"},{"post_id":"ciifri5l80001i2xxnoiodqpj","tag_id":"ciifri5ld0007i2xxfqxb56iz","_id":"ciifri5lf000ci2xxfub25fgv"},{"post_id":"ciifri5l80001i2xxnoiodqpj","tag_id":"ciifri5le0008i2xx0ice2lgb","_id":"ciifri5lf000di2xxd7zz2zbq"},{"post_id":"ciifri5lk000fi2xxbr6mfeb9","tag_id":"ciifri5la0003i2xx8ny3t399","_id":"ciifri5lm000ki2xxuydcbz8p"},{"post_id":"ciifri5lk000fi2xxbr6mfeb9","tag_id":"ciifri5lc0004i2xxdrom057p","_id":"ciifri5ln000li2xxey9uh127"},{"post_id":"ciifri5lk000fi2xxbr6mfeb9","tag_id":"ciifri5ld0006i2xxi8fifmfh","_id":"ciifri5ln000mi2xxzfq8v01n"},{"post_id":"ciifri5lk000fi2xxbr6mfeb9","tag_id":"ciifri5lm000hi2xxmdxe8z3x","_id":"ciifri5lo000ni2xxpranp6ts"},{"post_id":"ciifri5lk000fi2xxbr6mfeb9","tag_id":"ciifri5lm000ii2xx0kezzkt1","_id":"ciifri5lo000oi2xxwxcin61d"},{"post_id":"ciifri5lk000fi2xxbr6mfeb9","tag_id":"ciifri5lm000ji2xxfufjzpko","_id":"ciifri5lo000pi2xx9mpkid77"},{"post_id":"ciifri5kz0000i2xx6lnwhboy","tag_id":"ciifrqw6y0001qyxx6en1ip5o","_id":"ciifrqw730005qyxx4tvw849y"},{"post_id":"ciifri5kz0000i2xx6lnwhboy","tag_id":"ciifrqw720002qyxxzvfebdii","_id":"ciifrqw730006qyxxz4magb2o"},{"post_id":"ciifri5kz0000i2xx6lnwhboy","tag_id":"ciifri5le0008i2xx0ice2lgb","_id":"ciifrqw730007qyxxmwgfzfrv"},{"post_id":"ciifri5kz0000i2xx6lnwhboy","tag_id":"ciifrqw720003qyxxdireshla","_id":"ciifrqw730008qyxxqbvdur32"},{"post_id":"ciifri5kz0000i2xx6lnwhboy","tag_id":"ciifrqw730004qyxxw4nph48e","_id":"ciifrqw730009qyxxqr9q4tc4"}],"Tag":[{"name":"aliyun","_id":"ciifri5la0003i2xx8ny3t399"},{"name":"ecs","_id":"ciifri5lc0004i2xxdrom057p"},{"name":"centos","_id":"ciifri5ld0006i2xxi8fifmfh"},{"name":"nodejs","_id":"ciifri5ld0007i2xxfqxb56iz"},{"name":"hexo","_id":"ciifri5le0008i2xx0ice2lgb"},{"name":"nginx","_id":"ciifri5lm000hi2xxmdxe8z3x"},{"name":"ssl","_id":"ciifri5lm000ii2xx0kezzkt1"},{"name":"https","_id":"ciifri5lm000ji2xxfufjzpko"},{"name":"github","_id":"ciifrqw6y0001qyxx6en1ip5o"},{"name":"webhooks","_id":"ciifrqw720002qyxxzvfebdii"},{"name":"deploy","_id":"ciifrqw720003qyxxdireshla"},{"name":"shell","_id":"ciifrqw730004qyxxw4nph48e"}]}}