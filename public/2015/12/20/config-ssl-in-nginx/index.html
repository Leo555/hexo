<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>阿里云ECS配置Nginx和SSL · PPxu is me</title><meta name="description" content="今天给服务器安装了Nginx，并配置了SSL，网址左边终于有了萌萌哒的小绿锁，这里还是做一下记录。

先是安装Nginx
123$ wget http://ng"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"></head><body><header><a href="/" class="logo-link"><img src="/ppxu.jpg"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">博客</a></li><li class="nav-list-item"><a href="http://weibo.com/ppxu" target="_blank" class="nav-list-link">微博</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li><li class="nav-list-item"><a href="https://github.com/ppxu" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">阿里云ECS配置Nginx和SSL</h1><div class="post-meta"><div class="post-time">2015年12月20日</div></div><div class="post-content"><p>今天给服务器安装了Nginx，并配置了SSL，网址左边终于有了萌萌哒的小绿锁，这里还是做一下记录。</p>
<a id="more"></a>
<p>先是安装Nginx</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ wget http://nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm</div><div class="line">$ rpm -ivh nginx-release-centos-7-0.el7.ngx.noarch.rpm</div><div class="line">$ yum install nginx</div></pre></td></tr></table></figure>
<p>启动Nginx</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ systemctl start nginx</div></pre></td></tr></table></figure>
<p>这样Nginx服务就已经启动完成了，输入服务器ip地址就可以看到Nginx主页，然后我们需要把Hexo服务的4000端口转发到Nginx的80端口，查看Nginx配置文件<code>/etc/nginx/nginx.conf</code>，看到需要修改<code>conf.d</code>目录下的<code>/etc/nginx/conf.d/default.conf</code>文件</p>
<figure class="highlight tp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">    listen       <span class="number">80</span>;</div><div class="line">    server_name  ppxu.me *.ppxu.me;</div><div class="line"></div><div class="line">    location / &#123;</div><div class="line">        proxy_pass          http:<span class="comment">//127.0.0.1:4000/;</span></div><div class="line">        proxy_redirect      off;</div><div class="line">        proxy_set_header    <span class="keyword">X</span>-Real-IP       <span class="variable">$remote_addr</span>;</div><div class="line">        proxy_set_header    <span class="keyword">X</span>-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ...</div></pre></td></tr></table></figure>
<p>重启Nginx</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ systemctl restart nginx</div></pre></td></tr></table></figure>
<p>现在访问网站，在响应头里就可以看到<code>Server:nginx/1.8.0</code>，说明Nginx环境已经正常了，下面准备搞上HTTPS。</p>
<p>这里就不详述HTTPS的原理了，对我们这个小博客而言，搞个免费的SSL证书就可以了，这里推荐<a href="https://startssl.com/" target="_blank" rel="external">https://startssl.com/</a>或者<a href="https://www.wosign.com/" target="_blank" rel="external">https://www.wosign.com/</a>，申请成功后把下载下来的对应版本的证书文件上传到服务器上，包含公钥<code>xx.crt</code>和私钥<code>xx.key</code>。</p>
<p>然后编辑<code>/etc/nginx/conf.d/default.conf</code></p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">    listen       80;</div><div class="line">    listen       443 ssl;</div><div class="line">    server_name  ppxu.me *.ppxu.me;</div><div class="line"></div><div class="line">    ssl <span class="keyword">on</span>;</div><div class="line">    ssl_certificate /etc/nginx/<span class="keyword">conf</span>.<span class="keyword">d</span>/ppxu.crt;</div><div class="line">    ssl_certificate_key /etc/nginx/<span class="keyword">conf</span>.<span class="keyword">d</span>/ppxu.key;</div><div class="line">    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</div><div class="line">    ssl_ciphers 'AES128+EECDH:AES128+EDH:!aNULL';</div><div class="line">    ssl_prefer_server_ciphers <span class="keyword">on</span>;</div><div class="line">    ssl_session_cache shared:SSL:10m;</div><div class="line">    ssl_session_timeout 10m;</div><div class="line">    ssl_stapling <span class="keyword">on</span>;</div><div class="line">    ssl_stapling_verify <span class="keyword">on</span>;</div><div class="line"></div><div class="line">    location / &#123;</div><div class="line">        proxy_pass          http:<span class="comment">//127.0.0.1:4000/;</span></div><div class="line">        proxy_redirect      off;</div><div class="line">        proxy_set_header    X-Real-IP       <span class="variable">$remote_addr</span>;</div><div class="line">        proxy_set_header    X-Forwarded-<span class="keyword">For</span> <span class="variable">$proxy_add_x_forwarded_for</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ...</div></pre></td></tr></table></figure>
<p>重启Nginx，如果一切顺利，现在就可以通过<code>https://ppxu.me</code>访问到本网站了，但是如果直接输入<code>ppxu.me</code>的话会报400错误，显示</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">The plain HTTP request was sent to HTTPS port</div></pre></td></tr></table></figure>
<p>所以我们需要将http的请求强制使用https访问，最方便的办法是启用HSTS，在nginx的配置中添加</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">add_header </span><span class="keyword">Strict-Transport-Security </span><span class="string">"max-age=31536000; includeSubdomains"</span><span class="comment">;</span></div></pre></td></tr></table></figure>
<p>这样只要是支持HSTS的浏览器，就可以自动完成http到https的替换，而且是直接在浏览器本地完成的，对于不支持的浏览器，只能在服务器做重定向了，继续在Nginx配置中添加一条规则</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">error_page</span> <span class="number">497</span>  https://<span class="variable">$host</span><span class="variable">$uri</span>;</div></pre></td></tr></table></figure>
<p>这样我们的网站就已经完全支持了HTTPS访问，可以在这个网站<a href="https://www.ssllabs.com/ssltest/analyze.html" target="_blank" rel="external">https://www.ssllabs.com/ssltest/analyze.html</a>对网页进行安全评测，如果评分不够高的话可以再看看如何<a href="http://www.oschina.net/translate/strong_ssl_security_on_nginx" target="_blank" rel="external">加强nginx的SSL安全</a>。</p>
<p><img src="http://7xpbfd.com1.z0.glb.clouddn.com/ssl.png" alt="http://7xpbfd.com1.z0.glb.clouddn.com/ssl.png"></p>
<h4 id="参考资料"><a class="header-anchor" href="#参考资料">¶</a>参考资料</h4>
<ul>
<li><a href="http://codybonney.com/installing-nginx-on-centos-6-4/" target="_blank" rel="external">http://codybonney.com/installing-nginx-on-centos-6-4/</a></li>
<li><a href="http://www.tuijiankan.com/2015/05/04/%E9%98%BF%E9%87%8C%E4%BA%91Centos6%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AENodejs%E3%80%81Nginx%E3%80%81Hexo%E6%93%8D%E4%BD%9C%E8%AE%B0%E5%BD%95/" target="_blank" rel="external">http://www.tuijiankan.com/2015/05/04/阿里云Centos6安装配置Nodejs、Nginx、Hexo操作记录/</a></li>
<li><a href="http://www.barretlee.com/blog/2015/10/05/how-to-build-a-https-server/" target="_blank" rel="external">http://www.barretlee.com/blog/2015/10/05/how-to-build-a-https-server/</a></li>
<li><a href="https://imququ.com/post/switch-to-https.html" target="_blank" rel="external">https://imququ.com/post/switch-to-https.html</a></li>
<li><a href="https://imququ.com/post/sth-about-switch-to-https.html" target="_blank" rel="external">https://imququ.com/post/sth-about-switch-to-https.html</a></li>
<li><a href="http://www.ha97.com/5194.html" target="_blank" rel="external">http://www.ha97.com/5194.html</a></li>
<li><a href="http://www.cnblogs.com/yanghuahui/archive/2012/06/25/2561568.html" target="_blank" rel="external">http://www.cnblogs.com/yanghuahui/archive/2012/06/25/2561568.html</a></li>
<li><a href="http://www.codeceo.com/article/nginx-ssl-nodejs.html" target="_blank" rel="external">http://www.codeceo.com/article/nginx-ssl-nodejs.html</a></li>
<li><a href="http://www.ttlsa.com/nginx/nginx-node-js/" target="_blank" rel="external">http://www.ttlsa.com/nginx/nginx-node-js/</a></li>
<li><a href="http://blog.csdn.net/wzy_1988/article/details/8549290" target="_blank" rel="external">http://blog.csdn.net/wzy_1988/article/details/8549290</a></li>
<li><a href="http://www.tutugreen.com/wordpress/upgrade-ssl/" target="_blank" rel="external">http://www.tutugreen.com/wordpress/upgrade-ssl/</a></li>
<li><a href="http://www.oschina.net/translate/strong_ssl_security_on_nginx" target="_blank" rel="external">http://www.oschina.net/translate/strong_ssl_security_on_nginx</a></li>
<li><a href="http://blog.jobbole.com/44844/" target="_blank" rel="external">http://blog.jobbole.com/44844/</a></li>
<li><a href="http://blog.jobbole.com/80591/" target="_blank" rel="external">http://blog.jobbole.com/80591/</a></li>
<li><a href="https://imququ.com/post/my-nginx-conf-for-wpo.html" target="_blank" rel="external">https://imququ.com/post/my-nginx-conf-for-wpo.html</a></li>
</ul>
</div></article></div></section><footer><div class="paginator"><a href="/2015/12/21/auto-deploy-hexo-with-github-webhooks/" class="prev">上一篇</a><a href="/2015/12/19/install-nodejs-and-hexo-in-aliyun-centos/" class="next">下一篇</a></div><div data-thread-key="2015/12/20/config-ssl-in-nginx/" data-title="阿里云ECS配置Nginx和SSL" data-url="https://ppxu.me/2015/12/20/config-ssl-in-nginx/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"ppxu"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="powered"><p>Powered by<span>&nbsp;<a href="http://www.aliyun.com/" target="_blank">Aliyun</a></span><span>&nbsp;&&</span><span>&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a></span></p></div></footer><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src ="//hm.baidu.com/hm.js?3acd3117bffe31f23c04e3b8fec963fc";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script src="/js/snow.js"></script><script><var>snow = new Snow();</var></script></body></html>