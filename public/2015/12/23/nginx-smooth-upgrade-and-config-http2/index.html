<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="X-UA-Compatible" content="IE=edge">
    <title>平滑升级nginx并配置HTTP/2 · PPxu is me
    </title>
    <meta name="description" content="话说SPDY已经被HTTP/2上位了，网站继续用SPDY也不合适，今天就趁空升级了最新的Nginx，并开启了HTTP/2，下面是操作过程

检查当前Nginx版本和配置参数
123&lt;span cl">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <link rel="short icon" href="/favicon.png">
    <link rel="stylesheet" href="/css/apollo.css">
  </head>
  <body>
    <header><a href="/" class="logo-link"><img src="/favicon.png"></a>
      <ul class="nav nav-list">
        <li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">博客</a>
        </li>
        <li class="nav-list-item"><a href="http://weibo.com/ppxu" target="_blank" class="nav-list-link">微博</a>
        </li>
        <li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a>
        </li>
        <li class="nav-list-item"><a href="https://github.com/ppxu" target="_blank" class="nav-list-link">GITHUB</a>
        </li>
      </ul>
    </header>
    <section class="container">
            <div class="post">
              <article class="post-block">
                <h1 class="post-title">平滑升级nginx并配置HTTP/2
                </h1>
                      <div class="post-meta">
                        <div class="post-time">2015年12月23日
                        </div>
                      </div>
                <div class="post-content"><p>话说SPDY已经被HTTP/2上位了，网站继续用SPDY也不合适，今天就趁空升级了最新的Nginx，并开启了HTTP/2，下面是操作过程<br><a id="more"></a></p>
<ol>
<li><p>检查当前Nginx版本和配置参数</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nginx -V</span></span><br><span class="line">nginx <span class="symbol">version:</span> nginx/<span class="number">1.8</span>.<span class="number">0</span></span><br><span class="line">built by gcc <span class="number">4.8</span>.<span class="number">2</span> <span class="number">20140120</span> (<span class="constant">Red</span> <span class="constant">Hat</span> <span class="number">4.8</span>.<span class="number">2</span>-<span class="number">16</span>) (<span class="constant">GCC</span>)</span><br><span class="line">built <span class="keyword">with</span> <span class="constant">OpenSSL</span> <span class="number">1.0</span>.<span class="number">1</span>e-fips <span class="number">11</span> <span class="constant">Feb</span> <span class="number">2013</span></span><br><span class="line"><span class="constant">TLS</span> <span class="constant">SNI</span> support enabled</span><br><span class="line">configure <span class="symbol">arguments:</span> --prefix=<span class="regexp">/etc/nginx</span> --sbin-path=<span class="regexp">/usr/sbin</span><span class="regexp">/nginx --conf-path=/etc</span><span class="regexp">/nginx/nginx</span>.conf --error-log-path=<span class="regexp">/var/log</span><span class="regexp">/nginx/error</span>.log --http-log-path=<span class="regexp">/var/log</span><span class="regexp">/nginx/access</span>.log --pid-path=<span class="regexp">/var/run</span><span class="regexp">/nginx.pid --lock-path=/var</span><span class="regexp">/run/nginx</span>.lock --http-client-body-temp-path=<span class="regexp">/var/cache</span><span class="regexp">/nginx/client</span>_temp --http-proxy-temp-path=<span class="regexp">/var/cache</span><span class="regexp">/nginx/proxy</span>_temp --http-fastcgi-temp-path=<span class="regexp">/var/cache</span><span class="regexp">/nginx/fastcgi</span>_temp --http-uwsgi-temp-path=<span class="regexp">/var/cache</span><span class="regexp">/nginx/uwsgi</span>_temp --http-scgi-temp-path=<span class="regexp">/var/cache</span><span class="regexp">/nginx/scgi</span>_temp --user=nginx --group=nginx --<span class="keyword">with</span>-openssl=../libressl-<span class="number">2.2</span>.<span class="number">2</span> --<span class="keyword">with</span>-http_v2_module --<span class="keyword">with</span>-http_ssl_module --<span class="keyword">with</span>-http_realip_module --<span class="keyword">with</span>-http_addition_module --<span class="keyword">with</span>-http_sub_module --<span class="keyword">with</span>-http_dav_module --<span class="keyword">with</span>-http_flv_module --<span class="keyword">with</span>-http_mp4_module --<span class="keyword">with</span>-http_gunzip_module --<span class="keyword">with</span>-http_gzip_static_module --<span class="keyword">with</span>-http_random_index_module --<span class="keyword">with</span>-http_secure_link_module --<span class="keyword">with</span>-http_stub_status_module --<span class="keyword">with</span>-http_auth_request_module --<span class="keyword">with</span>-mail --<span class="keyword">with</span>-mail_ssl_module --<span class="keyword">with</span>-file-aio --<span class="keyword">with</span>-ipv6 --<span class="keyword">with</span>-http_spdy_module --<span class="keyword">with</span>-cc-opt=<span class="string">'-O2 -g -pipe -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector --param=ssp-buffer-size=4 -m64 -mtune=generic'</span></span><br></pre></td></tr></table></figure>
<p>记下这里的configure arguments，后面编译的时候要用的。</p>
</li>
<li><p>安装PCRE，Nginx的rewrite模块依赖PCRE</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># cd /ppxu</span></span><br><span class="line"><span class="preprocessor"># yum -y install make zlib zlib-devel gcc-c++ libtool</span></span><br><span class="line"><span class="preprocessor"># wget http://nchc.dl.sourceforge.net/project/pcre/pcre/8.37/pcre-8.37.tar.gz</span></span><br><span class="line"><span class="preprocessor"># tar zxvf pcre-8.37.tar.gz</span></span><br><span class="line"><span class="preprocessor"># cd pcre-8.37/</span></span><br><span class="line"><span class="preprocessor"># ./configure</span></span><br><span class="line"><span class="preprocessor"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>下载OpenSSL，可以从<a href="https://www.openssl.org/" target="_blank" rel="external">OpenSSL</a>或者<a href="http://www.libressl.org/" target="_blank" rel="external">LibreSSL</a>下载</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># cd /ppxu</span></span><br><span class="line"><span class="preprocessor"># wget http:<span class="comment">//ftp.openbsd.org/pub/OpenBSD/LibreSSL/libressl-2.3.1.tar.gz</span></span></span><br><span class="line"><span class="preprocessor"># tar zxvf libressl-<span class="number">2.3</span><span class="number">.1</span>.tar.gz</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>下载，配置并编译Nginx</p>
<figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span> <span class="comment">cd</span> <span class="comment">/ppxu</span></span><br><span class="line"><span class="comment">#</span> <span class="comment">wget</span> <span class="comment">http://nginx</span><span class="string">.</span><span class="comment">org/download/nginx</span><span class="literal">-</span><span class="comment">1</span><span class="string">.</span><span class="comment">9</span><span class="string">.</span><span class="comment">9</span><span class="string">.</span><span class="comment">tar</span><span class="string">.</span><span class="comment">gz</span></span><br><span class="line"><span class="comment">#</span> <span class="comment">tar</span> <span class="comment">zxvf</span> <span class="comment">nginx</span><span class="literal">-</span><span class="comment">1</span><span class="string">.</span><span class="comment">9</span><span class="string">.</span><span class="comment">9</span><span class="string">.</span><span class="comment">tar</span><span class="string">.</span><span class="comment">gz</span></span><br><span class="line"><span class="comment">#</span> <span class="comment">cd</span> <span class="comment">nginx</span><span class="literal">-</span><span class="comment">1</span><span class="string">.</span><span class="comment">9</span><span class="string">.</span><span class="comment">9/</span></span><br><span class="line"><span class="comment">#</span> <span class="string">.</span><span class="comment">/configure</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">prefix=/etc/nginx</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">sbin</span><span class="literal">-</span><span class="comment">path=/usr/sbin/nginx</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">conf</span><span class="literal">-</span><span class="comment">path=/etc/nginx/nginx</span><span class="string">.</span><span class="comment">conf</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">error</span><span class="literal">-</span><span class="comment">log</span><span class="literal">-</span><span class="comment">path=/var/log/nginx/error</span><span class="string">.</span><span class="comment">log</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">http</span><span class="literal">-</span><span class="comment">log</span><span class="literal">-</span><span class="comment">path=/var/log/nginx/access</span><span class="string">.</span><span class="comment">log</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">pid</span><span class="literal">-</span><span class="comment">path=/var/run/nginx</span><span class="string">.</span><span class="comment">pid</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">lock</span><span class="literal">-</span><span class="comment">path=/var/run/nginx</span><span class="string">.</span><span class="comment">lock</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">http</span><span class="literal">-</span><span class="comment">client</span><span class="literal">-</span><span class="comment">body</span><span class="literal">-</span><span class="comment">temp</span><span class="literal">-</span><span class="comment">path=/var/cache/nginx/client_temp</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">http</span><span class="literal">-</span><span class="comment">proxy</span><span class="literal">-</span><span class="comment">temp</span><span class="literal">-</span><span class="comment">path=/var/cache/nginx/proxy_temp</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">http</span><span class="literal">-</span><span class="comment">fastcgi</span><span class="literal">-</span><span class="comment">temp</span><span class="literal">-</span><span class="comment">path=/var/cache/nginx/fastcgi_temp</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">http</span><span class="literal">-</span><span class="comment">uwsgi</span><span class="literal">-</span><span class="comment">temp</span><span class="literal">-</span><span class="comment">path=/var/cache/nginx/uwsgi_temp</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">http</span><span class="literal">-</span><span class="comment">scgi</span><span class="literal">-</span><span class="comment">temp</span><span class="literal">-</span><span class="comment">path=/var/cache/nginx/scgi_temp</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">user=nginx</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">group=nginx</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">openssl=</span><span class="string">.</span><span class="string">.</span><span class="comment">/libressl</span><span class="literal">-</span><span class="comment">2</span><span class="string">.</span><span class="comment">3</span><span class="string">.</span><span class="comment">1</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">http_v2_module</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">http_ssl_module</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">http_realip_module</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">http_addition_module</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">http_sub_module</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">http_dav_module</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">http_flv_module</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">http_mp4_module</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">http_gunzip_module</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">http_gzip_static_module</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">http_random_index_module</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">http_secure_link_module</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">http_stub_status_module</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">http_auth_request_module</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">mail</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">mail_ssl_module</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">file</span><span class="literal">-</span><span class="comment">aio</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">ipv6</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">cc</span><span class="literal">-</span><span class="comment">opt='</span><span class="literal">-</span><span class="comment">O2</span> <span class="literal">-</span><span class="comment">g</span> <span class="literal">-</span><span class="comment">pipe</span> <span class="literal">-</span><span class="comment">Wp</span><span class="string">,</span><span class="literal">-</span><span class="comment">D_FORTIFY_SOURCE=2</span> <span class="literal">-</span><span class="comment">fexceptions</span> <span class="literal">-</span><span class="comment">fstack</span><span class="literal">-</span><span class="comment">protector</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">param=ssp</span><span class="literal">-</span><span class="comment">buffer</span><span class="literal">-</span><span class="comment">size=4</span> <span class="literal">-</span><span class="comment">m64</span> <span class="literal">-</span><span class="comment">mtune=generic'</span></span><br><span class="line"><span class="comment">#</span> <span class="comment">make</span></span><br></pre></td></tr></table></figure>
<p>其中的<code>--with-http_v2_module</code>就是开启HTTP/2的设置。</p>
</li>
<li><p>替换Nginx</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># which nginx    <span class="comment">//查找nginx路径</span></span><br><span class="line"># mv <span class="regexp">/usr/</span>sbin<span class="regexp">/nginx /u</span>sr<span class="regexp">/sbin/</span>nginx.old    <span class="comment">//备份旧版nginx</span></span><br><span class="line"># cp objs<span class="regexp">/nginx /u</span>sr<span class="regexp">/sbin/</span>    <span class="comment">//将编译好的新版nginx复制过去</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>确认更新生效</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /usr/sbin/nginx -t</span></span><br><span class="line">nginx: <span class="keyword">the</span> configuration <span class="type">file</span> /etc/nginx/nginx.conf syntax <span class="keyword">is</span> ok</span><br><span class="line">nginx: configuration <span class="type">file</span> /etc/nginx/nginx.conf test <span class="keyword">is</span> successful</span><br><span class="line"><span class="comment"># /usr/sbin/nginx -v</span></span><br><span class="line">nginx <span class="property">version</span>: nginx/<span class="number">1.9</span><span class="number">.9</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>更新Nginx配置文件</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80<span class="comment">;</span></span><br><span class="line">    listen       443 ssl http2<span class="comment">;</span></span><br><span class="line">    server_name  ppxu.me *.ppxu.me<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启Nginx即可</p>
</li>
</ol>
<p>访问网站，在响应头里可以看到<code>server:nginx/1.9.9</code>，同时，在<a href="chrome://net-internals/#http2" target="_blank" rel="external">chrome://net-internals/#http2</a>上面可以看到网站已经支持了HTTP/2</p>
<p><img src="http://7xpbfd.com1.z0.glb.clouddn.com/http2.png" alt="http://7xpbfd.com1.z0.glb.clouddn.com/http2.png"></p>
<h4 id="u53C2_u8003_u8D44_u6599"><a href="#u53C2_u8003_u8D44_u6599" class="headerlink" title="参考资料"></a>参考资料</h4><ul>
<li><a href="http://www.linuxde.net/2011/08/554.html" target="_blank" rel="external">http://www.linuxde.net/2011/08/554.html</a></li>
<li><a href="http://www.linuxidc.com/Linux/2014-02/96137.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2014-02/96137.htm</a></li>
<li><a href="http://www.poluoluo.com/server/201403/265778.html" target="_blank" rel="external">http://www.poluoluo.com/server/201403/265778.html</a></li>
<li><a href="https://imququ.com/post/http2-resource.html" target="_blank" rel="external">https://imququ.com/post/http2-resource.html</a></li>
<li><a href="https://imququ.com/post/nginx-http2-patch.html" target="_blank" rel="external">https://imququ.com/post/nginx-http2-patch.html</a></li>
<li><a href="http://www.tuicool.com/articles/3eeIVfi" target="_blank" rel="external">http://www.tuicool.com/articles/3eeIVfi</a></li>
</ul>

                </div>
              </article>
            </div>
    </section>
    <footer>
            <div class="paginator"><a class="prev"> </a><a href="/2015/12/22/config-spdy-in-nginx/" class="next">下一篇</a>
            </div>
      <div data-thread-key="2015/12/23/nginx-smooth-upgrade-and-config-http2/" data-title="平滑升级nginx并配置HTTP/2" data-url="https://ppxu.me/2015/12/23/nginx-smooth-upgrade-and-config-http2/" data-author-key="1" class="ds-thread"></div>
      <script>
        var duoshuoQuery = {short_name:"ppxu"};
        (function() {
            var ds = document.createElement('script');
            ds.type = 'text/javascript';ds.async = true;
            ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
            ds.charset = 'UTF-8';
            (document.getElementsByTagName('head')[0] 
             || document.getElementsByTagName('body')[0]).appendChild(ds);
        })();
        
        
      </script>
      <div class="powered">
        <p>Powered by<span>&nbsp;<a href="http://www.aliyun.com/" target="_blank">Aliyun</a></span><span>&nbsp;&</span><span>&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a></span></p>
      </div>
    </footer>
    <script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src ="//hm.baidu.com/hm.js?3acd3117bffe31f23c04e3b8fec963fc";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();
    </script>
  </body>
</html>